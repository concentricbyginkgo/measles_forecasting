---
title: "Measles season clustering"
author: "Amanda Meadows"
date: "`r format(Sys.Date(), '%m-%d-%Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(data.table)
library(widyr)
library(tidyverse)
library(ggthemes)
library(rworldmap)
library(leaflet)
library(plotly)
library(DT)
theme_set(theme_bw())
```

# Introduction

* Exploring clustering of countries by climate predictors that would indicate measles season.
* Using k-means clustering accounting for temporal dynamics
* Subset to countries with at least one outbreak (phase 1)
  + Performed phase 2 of clustering for countries with no reported outbreaks
* Measles seasonal cutoff is chosen by visual inspection of epi curves of countries within clusters.

# Phase 1{.tabset .tabset-pills}

```{r}
inputDat <- fread("~/measles_forecasting/alpha_model/input/processed_measles_model_data.csv", na.strings = "")
inputDat[, cluster := NULL]
cutoffDat <- unique(inputDat[, .(ISO3, Country)])
inputDat[, date := as.Date(date)]
inputDat[inputDat[outbreak_20_cuml_per_M == "yes", .N, by = .(ISO3, Year)][, .N, by = .(ISO3)], years_with_outbreak := i.N, on = .(ISO3)]
outbreakDat <- unique(inputDat[, .(ISO3, Country, years_with_outbreak)])
outbreakDat <- outbreakDat[order(-years_with_outbreak)]
inputDat <- inputDat[years_with_outbreak > 0]
```

```{r}
get_clusters <- function(var, n_clusters){
  cluster_input <- inputDat[, .(ISO3, date, get(var))]
  # Perform k-means clustering using widely_kmeans
  set.seed(0)
  cluster_group <-  cluster_input %>%
    widely_kmeans(item = ISO3, 
                  feature = date, 
                  value = V3,
                  k = n_clusters) %>% 
    as.data.table()
  cluster_group[, cluster := factor(cluster, levels = c(1:n_clusters))]
  setnames(cluster_input, "V3", var)
  # Join the clustering results back to the original data
  input_with_cluster <- left_join(inputDat, cluster_group)
  return(input_with_cluster)
}

cols <- c("#268bd2", "#b58900", "#cb4b16", "#dc322f",
          "#d33682", "#6c71c4", "#2aa198", "#859900")
```

```{r}
worlddata <- getMap(resolution='low')
worlddata$ISO_A2[is.na(worlddata$ISO_A2)]<-"NA"

map_clusters <- function(cluster_dat, world_dat){
  worddata <- copy(world_dat)
  map_data_order <- data.table(ISO2 = worlddata$ISO_A2, ISO3= worlddata$ISO_A3)
  country_cluster <- unique(cluster_dat[, .(ISO3, cluster)])
  map_data_order <- merge(map_data_order, country_cluster, by = "ISO3", all.x = T)
  worlddata <- merge(worlddata, map_data_order, by.x = "ISO_A3", by.y = "ISO3", all.x = T)
  #RColorBrewer::brewer.pal(7, "YlOrRd")
  cols <- c("#268bd2", "#b58900", "#cb4b16", "#dc322f",
            "#d33682", "#6c71c4", "#2aa198", "#859900")
  factpal <- colorFactor(palette = cols, worlddata$cluster)
  
  leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron,
                     options = providerTileOptions(noWrap = TRUE)) %>% 
    addPolygons(data = worlddata, color = ~factpal(cluster), weight = 1, smoothFactor = 0.5,
                opacity = 0.25, fillOpacity = 0.5) %>% 
    addCircleMarkers(data = worlddata, ~LON, ~LAT, 
                     popup = worlddata$ADMIN,
                     weight = 0.5, radius = 1.5, fillColor = "black", color = "black") %>% 
    addLegend("bottomright", pal = factpal, values = worlddata$cluster,
              title = "Cluster",  opacity = 0.5) %>% 
    setView(-60, 42.3489054, zoom = 2)
}
```

## Temperature 

```{r}
temp_cluster <- get_clusters(var = "mean_max_temp", n_clusters = 4)
temp_cluster[, .N, by = .(ISO3, cluster)][, .N, by = .(cluster)][order(-N)]
```

```{r}
map_clusters(cluster_dat = temp_cluster, world_dat = worlddata)
```

```{r}
ggplotly(temp_cluster %>%
           ggplot(aes(x = date, y = cases_1M, group = ISO3, colour = cluster)) +
           geom_line(show.legend = F)+ scale_color_manual(values = cols))
```

## Precipitation

```{r}
precip_cluster <- get_clusters(var = "mean_precip_mm_per_day", n_clusters = 4)
precip_cluster[, .N, by = .(ISO3, cluster)][, .N, by = .(cluster)][order(-N)]
```

```{r}
map_clusters(cluster_dat = precip_cluster, world_dat = worlddata)
```

```{r}
ggplotly(precip_cluster %>%
           ggplot(aes(x = date, y = cases_1M, group = ISO3, colour = cluster)) +
           geom_line(show.legend = F)+ scale_color_manual(values = cols))
```

```{r}
pclust <- unique(precip_cluster[, .(ISO3, precipitation_cluster = cluster)])
tclust <- unique(temp_cluster[, .(ISO3, temperature_cluster = cluster)])
cutoffDat[pclust, precipitation_cluster := i.precipitation_cluster, on = .(ISO3)]
cutoffDat[tclust, temperature_cluster := i.temperature_cluster, on = .(ISO3)]

cutoffDat[precipitation_cluster != 2, cutoff_month := 8]
cutoffDat[temperature_cluster %in% c(1,2), cutoff_month := 10]
manual_iso3 <- cutoffDat[is.na(cutoff_month)]$ISO3

cutoffDat[ISO3 == "YEM", cutoff_month := 8]
cutoffDat[ISO3 == "SDN", cutoff_month := 10]
cutoffDat[ISO3 == "SOM", cutoff_month := 8]
cutoffDat[ISO3 == "QAT", cutoff_month := 8]
cutoffDat[ISO3 == "PAK", cutoff_month := 8]
cutoffDat[ISO3 == "ARE", cutoff_month := 8]
cutoffDat[ISO3 == "SEN", cutoff_month := 10]
cutoffDat[ISO3 == "OMN", cutoff_month := 8]
cutoffDat[ISO3 == "NER", cutoff_month := 10]
cutoffDat[ISO3 == "NAM", cutoff_month := 6]
cutoffDat[ISO3 == "MRT", cutoff_month := 8]
cutoffDat[ISO3 == "MLI", cutoff_month := 8]
cutoffDat[ISO3 == "LBY", cutoff_month := 10]
cutoffDat[ISO3 == "LSO", cutoff_month := 6]
cutoffDat[ISO3 == "KWT", cutoff_month := 8]
cutoffDat[ISO3 == "KEN", cutoff_month := 10]
cutoffDat[ISO3 == "ISR", cutoff_month := 8]
cutoffDat[ISO3 == "IRQ", cutoff_month := 8]
cutoffDat[ISO3 == "GNB", cutoff_month := 10]
cutoffDat[ISO3 == "GMB", cutoff_month := 10]
cutoffDat[ISO3 == "FJI", cutoff_month := 2]
cutoffDat[ISO3 == "NZL", cutoff_month := 2]
cutoffDat[ISO3 == "ETH", cutoff_month := 8]
cutoffDat[ISO3 == "ERI", cutoff_month := 10]
cutoffDat[ISO3 == "EGY", cutoff_month := 8]
cutoffDat[ISO3 == "DJI", cutoff_month := 8]
cutoffDat[ISO3 == "COM", cutoff_month := 10]
cutoffDat[ISO3 == "TCD", cutoff_month := 8]
cutoffDat[ISO3 == "BDI", cutoff_month := 8]
cutoffDat[ISO3 == "BWA", cutoff_month := 8]
cutoffDat[ISO3 == "DZA", cutoff_month := 10]
cutoffDat[ISO3 == "SLB", cutoff_month := 10]
cutoffDat[ISO3 == "TUN", cutoff_month := 10]

low_iso3 <- cutoffDat[is.na(cutoff_month)]$ISO3
```


# Phase 2 {.tabset .tabset-pills}

Countries with no reported outbreaks

```{r}
inputDat2 <- fread("~/measles_forecasting/alpha_model/input/processed_measles_model_data.csv", na.strings = "")
inputDat2[, cluster:=NULL]
inputDat2[, date := as.Date(date)]
low_inputDat <- inputDat2[ISO3 %in% low_iso3]
```

```{r}
get_low_clusters <- function(var, n_clusters){
  cluster_input <- low_inputDat[, .(ISO3, date, get(var))]
  # Perform k-means clustering using widely_kmeans
  set.seed(0)
  cluster_group <-  cluster_input %>%
    widely_kmeans(item = ISO3, 
                  feature = date, 
                  value = V3,
                  k = n_clusters) %>% 
    as.data.table()
  cluster_group[, cluster := factor(cluster, levels = c(1:n_clusters))]
  setnames(cluster_input, "V3", var)
  # Join the clustering results back to the original data
  input_with_cluster <- left_join(low_inputDat, cluster_group)
  return(input_with_cluster)
}
```

```{r}
map_low_clusters <- function(cluster_dat, world_dat){
  worddata <- copy(world_dat)
  map_data_order <- data.table(ISO2 = worlddata$ISO_A2, ISO3= worlddata$ISO_A3)
  country_cluster <- unique(cluster_dat[, .(ISO3, cluster)])
  map_data_order <- merge(map_data_order, country_cluster, by = "ISO3", all.x = T)
  worlddata <- merge(worlddata, map_data_order, by.x = "ISO_A3", by.y = "ISO3", all.x = T)
  #RColorBrewer::brewer.pal(7, "YlOrRd")
  cols <- c("#268bd2", "#b58900", "#cb4b16", "#dc322f",
            "#d33682", "#6c71c4", "#2aa198", "#859900")
  factpal <- colorFactor(palette = cols, worlddata$cluster)
  
  leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron,
                     options = providerTileOptions(noWrap = TRUE)) %>% 
    addPolygons(data = worlddata, color = ~factpal(cluster), weight = 1, smoothFactor = 0.5,
                opacity = 0.25, fillOpacity = 0.5) %>% 
    addCircleMarkers(data = worlddata, ~LON, ~LAT, 
                     popup = worlddata$ADMIN,
                     weight = 0.5, radius = 1.5, fillColor = "black", color = "black") %>% 
    addLegend("bottomright", pal = factpal, values = worlddata$cluster,
              title = "Cluster",  opacity = 0.5) %>% 
    setView(-60, 42.3489054, zoom = 2)
}
```

## Temperature

```{r}
low_temp_cluster <- get_low_clusters(var = "mean_max_temp", n_clusters = 3)
low_temp_cluster[, .N, by = .(cluster, ISO3)][, .N, by = .(cluster)]
low_inputDat[low_temp_cluster, temp_cluster := i.cluster, on = .(ISO3)]
```

```{r}
map_low_clusters(cluster_dat = low_temp_cluster, world_dat = worlddata)
```

```{r}
ggplotly(ggplot(low_inputDat[temp_cluster == 2]) + (geom_line(aes(x = date, y = cases_1M, group = Country))))
low_inputDat[temp_cluster == 2, cutoff_month := 10]
low_inputDat[temp_cluster == 1, cutoff_month := 10]
```

## Precipitation

```{r}
low_precip_cluster <- get_low_clusters(var = "mean_precip_mm_per_day", n_clusters = 3)
low_precip_cluster[, .N, by = .(cluster, ISO3)][, .N, by = .(cluster)]
```

```{r}
map_low_clusters(cluster_dat = low_precip_cluster, world_dat = worlddata)
```

```{r}
low_inputDat[low_precip_cluster, precip_cluster := i.cluster, on = .(ISO3)]
low_inputDat[is.na(cutoff_month) & precip_cluster == 1, cutoff_month := 2]
low_inputDat[is.na(cutoff_month) & precip_cluster == 2, cutoff_month := 2]
```

# Seasonal cutoffs {.tabset .tabset-pills}

```{r}
# manual cutoff (look at epi curve)
#low_inputDat[is.na(cutoff_month)][, .N, by = .(ISO3)]
low_inputDat[ISO3 == "AUS", cutoff_month := 2]
low_inputDat[ISO3 == "ZAF", cutoff_month := 2]
low_inputDat[ISO3 == "VUT", cutoff_month := 2]
low_inputDat[ISO3 == "BHS", cutoff_month := 3]
low_inputDat[ISO3 == "BRN", cutoff_month := 10]
low_inputDat[ISO3 == "JOR", cutoff_month := 10]
low_inputDat[ISO3 == "SAU", cutoff_month := 10]
low_inputDat[ISO3 == "CRI", cutoff_month := 8]
low_inputDat[ISO3 == "CUB", cutoff_month := 8]
low_inputDat[ISO3 == "GTM", cutoff_month := 8]
low_inputDat[ISO3 == "HTI", cutoff_month := 8]
low_inputDat[ISO3 == "HND", cutoff_month := 8]
low_inputDat[ISO3 == "JAM", cutoff_month := 8]
low_inputDat[ISO3 == "MUS", cutoff_month := 8]
low_inputDat[ISO3 == "TTO", cutoff_month := 8]
low_inputDat[ISO3 == "MEX", cutoff_month := 6]
low_inputDat[ISO3 == "RWA", cutoff_month := 6]
#ggplotly(ggplot(low_inputDat[is.na(cutoff_month)]) + (geom_line(aes(x = date, y = cases_1M, color = Country))))

low_cutoffDat <- unique(low_inputDat[, .(ISO3, cutoff_month)])
cutoffDat[low_cutoffDat, cutoff_month := i.cutoff_month, on = .(ISO3)]
```

```{r}
o1 <- geom_vline(xintercept = c(as.Date("2012-10-01"), as.Date("2013-10-01"), as.Date("2014-10-01"), 
                                as.Date("2015-10-01"), as.Date("2016-10-01"), as.Date("2017-10-01"),
                                as.Date("2018-10-01"), as.Date("2019-10-01"), as.Date("2020-10-01"),
                                as.Date("2021-10-01"), as.Date("2022-10-01"), as.Date("2011-10-01")), color = "blue")
o2 <-  geom_vline(xintercept = c(as.Date("2012-08-01"), as.Date("2013-08-01"), as.Date("2014-08-01"), 
                                 as.Date("2015-08-01"), as.Date("2016-08-01"), as.Date("2017-08-01"),
                                 as.Date("2018-08-01"), as.Date("2019-08-01"), as.Date("2020-08-01"),
                                 as.Date("2021-08-01"), as.Date("2022-08-01"), as.Date("2011-08-01")), color = "blue")
o3 <-  geom_vline(xintercept = c(as.Date("2012-06-01"), as.Date("2013-06-01"), as.Date("2014-06-01"), 
                                 as.Date("2015-06-01"), as.Date("2016-06-01"), as.Date("2017-06-01"),
                                 as.Date("2018-06-01"), as.Date("2019-06-01"), as.Date("2020-06-01"),
                                 as.Date("2021-06-01"), as.Date("2022-06-01"), as.Date("2011-06-01")), color = "blue")
o4 <-  geom_vline(xintercept = c(as.Date("2012-02-01"), as.Date("2013-02-01"), as.Date("2014-02-01"), 
                                 as.Date("2015-02-01"), as.Date("2016-02-01"), as.Date("2017-02-01"),
                                 as.Date("2018-02-01"), as.Date("2019-02-01"), as.Date("2020-02-01"),
                                 as.Date("2021-02-01"), as.Date("2022-02-01"), as.Date("2011-02-01")), color = "blue")
```

## Epi curve with cutoffs indicated

```{r}
inputDat[cutoffDat, cutoff_month := i.cutoff_month, on = .(ISO3)]
ggplot(inputDat[cutoff_month == 2]) + geom_line(aes(x = date, y = cases_1M, group = ISO3))+ o4 + ggtitle("Feb cutoff")
ggplot(inputDat[cutoff_month == 6]) + geom_line(aes(x = date, y = cases_1M, group = ISO3))+ o3 + ggtitle("June cutoff")
ggplot(inputDat[cutoff_month == 8]) + geom_line(aes(x = date, y = cases_1M, group = ISO3))+ o2 + ggtitle("August cutoff")
ggplot(inputDat[cutoff_month == 10]) + geom_line(aes(x = date, y = cases_1M, group = ISO3))+ o1 + ggtitle("October cutoff")
```

## Map of seasonal cutoff months

```{r}
map_data_order <- data.table(ISO2 = worlddata$ISO_A2, ISO3= worlddata$ISO_A3)
map_data_order <- merge(map_data_order, cutoffDat[, .(ISO3, cutoff_month)], by = "ISO3", all.x = T)
wdata <- merge(worlddata, map_data_order, by.x = "ISO_A3", by.y = "ISO3", all.x = T)
#RColorBrewer::brewer.pal(7, "YlOrRd")
cols <- c("#268bd2", "#b58900", "#cb4b16", "#dc322f",
          "#d33682", "#6c71c4", "#2aa198", "#859900")
factpal <- colorFactor(palette = cols, wdata$cutoff_month)

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron,
                   options = providerTileOptions(noWrap = TRUE)) %>% 
  addPolygons(data = wdata, color = ~factpal(cutoff_month), weight = 1, smoothFactor = 0.5,
              opacity = 0.25, fillOpacity = 0.5) %>% 
  addCircleMarkers(data = worlddata, ~LON, ~LAT, 
                   popup = worlddata$ADMIN,
                   weight = 0.5, radius = 1.5, fillColor = "black", color = "black") %>% 
  addLegend("bottomright", pal = factpal, values = wdata$cutoff_month,
            title = "Cutoff month",  opacity = 0.5) %>% 
  setView(-60, 42.3489054, zoom = 2)
```

```{r}
#fwrite(cutoffDat, "cutoff_month_by_country.csv")
```